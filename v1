Option Explicit

Sub PreviewAndCreateYearlyFolderStructure()
    Dim ns As Outlook.NameSpace
    Dim TargetInbox As Outlook.MAPIFolder
    Dim ArchiveFolder As Outlook.MAPIFolder
    Dim ParentFolder As Outlook.MAPIFolder
    Dim MonthFolder As Outlook.MAPIFolder
    Dim DayFolder As Outlook.MAPIFolder
    Dim LastBusinessDayFolder As Outlook.MAPIFolder
    Dim SubFolder As Outlook.MAPIFolder
    Dim i As Integer
    Dim StartDate As Date, EndDate As Date, CurrentDate As Date, LastBusinessDay As Date
    Dim MonthStr As String, DayStr As String
    Dim FolderName As String
    Dim SubFolderNames As Variant
    Dim j As Integer
    Dim previewMsg As String
    Dim response As VbMsgBoxResult

    ' List of subfolders for the last business day
    SubFolderNames = Array("0 FX London", "1 FX Toronto", "2 GEDA GELP", "3 FX Options", _
                           "4 Structured Credit", "5 Structured Rates", "6 Bonds", _
                           "7 Commodities", "8 London IRS", "9 Toronto IRS", "9.1 CDS")

    Set ns = Application.Session

    ' Prompt user to select the target inbox
    Set TargetInbox = ns.PickFolder
    If TargetInbox Is Nothing Then
        MsgBox "No folder selected. Exiting.", vbExclamation
        Exit Sub
    End If

    ' Find "Archive - Valuation Reports" folder inside the selected inbox
    On Error Resume Next
    Set ArchiveFolder = TargetInbox.Folders("Archive - Valuation Reports")
    On Error GoTo 0
    If ArchiveFolder Is Nothing Then
        MsgBox "The folder 'Archive - Valuation Reports' was not found inside " & TargetInbox.Name & ".", vbExclamation
        Exit Sub
    End If

    ' Find "2025" folder inside "Archive - Valuation Reports"
    On Error Resume Next
    Set ParentFolder = ArchiveFolder.Folders("2025")
    On Error GoTo 0
    If ParentFolder Is Nothing Then
        MsgBox "The folder '2025' was not found inside 'Archive - Valuation Reports'. Please create it first.", vbExclamation
        Exit Sub
    End If

    previewMsg = "The following changes will be made:" & vbCrLf & String(50, "-") & vbCrLf

    ' Loop through all months (January to December)
    For i = 1 To 12
        MonthStr = Format(i, "00")
        FolderName = "2025." & MonthStr
        
        ' Check if the month folder exists
        On Error Resume Next
        Set MonthFolder = ParentFolder.Folders(FolderName)
        On Error GoTo 0
        If MonthFolder Is Nothing Then
            previewMsg = previewMsg & "- Create month folder: " & FolderName & vbCrLf
        End If
        
        ' Determine start and end dates for the month
        StartDate = DateSerial(2025, i, 1)
        EndDate = DateSerial(2025, i + 1, 0)
        
        ' Determine last business day of the month
        LastBusinessDay = EndDate
        Do While Weekday(LastBusinessDay, vbMonday) > 5
            LastBusinessDay = LastBusinessDay - 1
        Loop
        
        ' Loop through each day in the month
        CurrentDate = StartDate
        Do While CurrentDate <= EndDate
            If Weekday(CurrentDate, vbMonday) <= 5 Then  ' Only business days (Mon-Fri)
                DayStr = "2025." & MonthStr & "." & Format(Day(CurrentDate), "00")
                On Error Resume Next
                Set DayFolder = MonthFolder.Folders(DayStr)
                On Error GoTo 0
                If DayFolder Is Nothing Then
                    previewMsg = previewMsg & "- Create business day folder: " & DayStr & vbCrLf
                End If
                
                ' If this day is the last business day, check subfolders
                If CurrentDate = LastBusinessDay Then
                    On Error Resume Next
                    Set LastBusinessDayFolder = MonthFolder.Folders(DayStr)
                    On Error GoTo 0
                    If Not LastBusinessDayFolder Is Nothing Then
                        ' Check for missing subfolders
                        For j = LBound(SubFolderNames) To UBound(SubFolderNames)
                            On Error Resume Next
                            Set SubFolder = LastBusinessDayFolder.Folders(SubFolderNames(j))
                            On Error GoTo 0
                            If SubFolder Is Nothing Then
                                previewMsg = previewMsg & "  - Add subfolder: " & SubFolderNames(j) & " inside " & DayStr & vbCrLf
                            End If
                        Next j
                    Else
                        ' Last business day folder does not exist yet; it will be created
                        previewMsg = previewMsg & "- Create last business day folder: " & DayStr & vbCrLf
                        For j = LBound(SubFolderNames) To UBound(SubFolderNames)
                            previewMsg = previewMsg & "  - Add subfolder: " & SubFolderNames(j) & " inside " & DayStr & vbCrLf
                        Next j
                    End If
                End If
            End If
            CurrentDate = CurrentDate + 1
        Loop
    Next i

    ' Display preview and ask for confirmation
    response = MsgBox(previewMsg & vbCrLf & "Do you want to proceed?", vbYesNo + vbQuestion, "Preview Changes")
    If response = vbNo Then
        MsgBox "Operation cancelled.", vbInformation
        Exit Sub
    End If

    ' If confirmed, call the folder creation sub
    CreateFolders TargetInbox
End Sub

Sub CreateFolders(TargetInbox As Outlook.MAPIFolder)
    Dim ns As Outlook.NameSpace
    Dim ArchiveFolder As Outlook.MAPIFolder
    Dim ParentFolder As Outlook.MAPIFolder
    Dim MonthFolder As Outlook.MAPIFolder
    Dim DayFolder As Outlook.MAPIFolder
    Dim LastBusinessDayFolder As Outlook.MAPIFolder
    Dim SubFolder As Outlook.MAPIFolder
    Dim i As Integer
    Dim StartDate As Date, EndDate As Date, CurrentDate As Date, LastBusinessDay As Date
    Dim MonthStr As String, DayStr As String
    Dim FolderName As String
    Dim SubFolderNames As Variant
    Dim j As Integer

    SubFolderNames = Array("0 FX London", "1 FX Toronto", "2 GEDA GELP", "3 FX Options", _
                           "4 Structured Credit", "5 Structured Rates", "6 Bonds", _
                           "7 Commodities", "8 London IRS", "9 Toronto IRS", "9.1 CDS")

    Set ns = Application.Session

    ' Locate the "Archive - Valuation Reports" folder in the selected inbox
    On Error Resume Next
    Set ArchiveFolder = TargetInbox.Folders("Archive - Valuation Reports")
    On Error GoTo 0
    If ArchiveFolder Is Nothing Then
        MsgBox "The folder 'Archive - Valuation Reports' was not found inside " & TargetInbox.Name & ".", vbExclamation
        Exit Sub
    End If

    ' Locate the "2025" folder inside "Archive - Valuation Reports"
    On Error Resume Next
    Set ParentFolder = ArchiveFolder.Folders("2025")
    On Error GoTo 0
    If ParentFolder Is Nothing Then
        MsgBox "The folder '2025' was not found inside 'Archive - Valuation Reports'. Please create it first.", vbExclamation
        Exit Sub
    End If

    ' Loop through each month (January to December)
    For i = 1 To 12
        MonthStr = Format(i, "00")
        FolderName = "2025." & MonthStr
        On Error Resume Next
        Set MonthFolder = ParentFolder.Folders(FolderName)
        On Error GoTo 0
        If MonthFolder Is Nothing Then
            Set MonthFolder = ParentFolder.Folders.Add(FolderName, olFolder)
        End If

        StartDate = DateSerial(2025, i, 1)
        EndDate = DateSerial(2025, i + 1, 0)
        LastBusinessDay = EndDate
        Do While Weekday(LastBusinessDay, vbMonday) > 5
            LastBusinessDay = LastBusinessDay - 1
        Loop

        CurrentDate = StartDate
        Do While CurrentDate <= EndDate
            If Weekday(CurrentDate, vbMonday) <= 5 Then
                DayStr = "2025." & MonthStr & "." & Format(Day(CurrentDate), "00")
                On Error Resume Next
                Set DayFolder = MonthFolder.Folders(DayStr)
                On Error GoTo 0
                If DayFolder Is Nothing Then
                    Set DayFolder = MonthFolder.Folders.Add(DayStr, olFolder)
                End If

                ' If this is the last business day, ensure subfolders are created
                If CurrentDate = LastBusinessDay Then
                    On Error Resume Next
                    Set LastBusinessDayFolder = MonthFolder.Folders(DayStr)
                    On Error GoTo 0
                    If LastBusinessDayFolder Is Nothing Then
                        Set LastBusinessDayFolder = MonthFolder.Folders.Add(DayStr, olFolder)
                    End If
                    For j = LBound(SubFolderNames) To UBound(SubFolderNames)
                        On Error Resume Next
                        Set SubFolder = LastBusinessDayFolder.Folders(SubFolderNames(j))
                        On Error GoTo 0
                        If SubFolder Is Nothing Then
                            Set SubFolder = LastBusinessDayFolder.Folders.Add(SubFolderNames(j), olFolder)
                        End If
                    Next j
                End If
            End If
            CurrentDate = CurrentDate + 1
        Loop
    Next i

    MsgBox "Folders created successfully in 'Archive - Valuation Reports' inside " & TargetInbox.Name & "!", vbInformation
End Sub
