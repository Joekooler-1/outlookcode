Option Explicit

' Helper function: Returns an existing subfolder or creates it if it doesn't exist.
Function GetOrCreateFolder(ByVal ParentFolder As Outlook.MAPIFolder, FolderName As String) As Outlook.MAPIFolder
    Dim f As Outlook.MAPIFolder
    On Error Resume Next
    Set f = ParentFolder.Folders(FolderName)
    On Error GoTo 0
    If f Is Nothing Then
        Set f = ParentFolder.Folders.Add(FolderName)
    End If
    Set GetOrCreateFolder = f
End Function

Sub CreateYearlyFolderStructure()
    Dim ns As Outlook.NameSpace
    Dim TargetInbox As Outlook.MAPIFolder, ArchiveFolder As Outlook.MAPIFolder, ParentFolder As Outlook.MAPIFolder
    Dim MonthFolder As Outlook.MAPIFolder, DayFolder As Outlook.MAPIFolder, LastBusinessDayFolder As Outlook.MAPIFolder
    Dim SubFolder As Outlook.MAPIFolder
    Dim i As Integer, j As Integer
    Dim StartDate As Date, EndDate As Date, CurrentDate As Date, LastBusinessDay As Date
    Dim MonthStr As String, DayStr As String, FolderName As String
    Dim SubFolderNames As Variant
    
    ' List of subfolders to add on the last business day
    SubFolderNames = Array("0 FX London", "1 FX Toronto", "2 GEDA GELP", "3 FX Options", _
                           "4 Structured Credit", "5 Structured Rates", "6 Bonds", _
                           "7 Commodities", "8 London IRS", "9 Toronto IRS", "9.1 CDS")
    
    Set ns = Application.Session
    
    ' Prompt the user to select the target inbox
    Set TargetInbox = ns.PickFolder
    If TargetInbox Is Nothing Then
        MsgBox "No folder selected. Exiting.", vbExclamation
        Exit Sub
    End If
    
    ' Locate (or create) "Archive - Valuation Reports" within the selected inbox
    Set ArchiveFolder = GetOrCreateFolder(TargetInbox, "Archive - Valuation Reports")
    If ArchiveFolder Is Nothing Then
        MsgBox "Unable to locate or create 'Archive - Valuation Reports' folder.", vbExclamation
        Exit Sub
    End If
    
    ' Locate (or create) the "2025" folder inside "Archive - Valuation Reports"
    Set ParentFolder = GetOrCreateFolder(ArchiveFolder, "2025")
    If ParentFolder Is Nothing Then
        MsgBox "Unable to locate or create '2025' folder.", vbExclamation
        Exit Sub
    End If
    
    ' Loop through each month (January to December)
    For i = 1 To 12
        MonthStr = Format(i, "00")
        FolderName = "2025." & MonthStr
        
        ' Get or create the month folder under "2025"
        Set MonthFolder = GetOrCreateFolder(ParentFolder, FolderName)
        
        ' Set start and end dates for the month
        StartDate = DateSerial(2025, i, 1)
        EndDate = DateSerial(2025, i + 1, 0)
        
        ' Determine the last business day of the month
        LastBusinessDay = EndDate
        Do While Weekday(LastBusinessDay, vbMonday) > 5
            LastBusinessDay = LastBusinessDay - 1
        Loop
        
        ' Loop through each day in the month (only business days: Monday-Friday)
        CurrentDate = StartDate
        Do While CurrentDate <= EndDate
            If Weekday(CurrentDate, vbMonday) <= 5 Then
                DayStr = "2025." & MonthStr & "." & Format(Day(CurrentDate), "00")
                
                ' Get or create the day folder under the month folder
                Set DayFolder = GetOrCreateFolder(MonthFolder, DayStr)
                
                ' If this day is the last business day, add the subfolders
                If CurrentDate = LastBusinessDay Then
                    Set LastBusinessDayFolder = DayFolder
                    For j = LBound(SubFolderNames) To UBound(SubFolderNames)
                        Set SubFolder = GetOrCreateFolder(LastBusinessDayFolder, SubFolderNames(j))
                    Next j
                End If
            End If
            CurrentDate = CurrentDate + 1
        Loop
    Next i
    
    MsgBox "Folders created successfully in 'Archive - Valuation Reports' inside " & TargetInbox.Name & "!", vbInformation
End Sub
